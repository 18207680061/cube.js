{"componentChunkName":"component---guides-base-src-templates-post-jsx","path":"/data-collection-and-storage","result":{"data":{"markdownRemark":{"html":"<p>We're going to use Snowplow for data collection, S3 for storage, and Athena to query the data in S3.</p>\n<h2 id=\"data-collection-with-snowplow\" style=\"position:relative;\"><a href=\"#data-collection-with-snowplow\" aria-label=\"data collection with snowplow permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Data Collection with Snowplow</h2>\n<p>Snowplow is an analytics platform to collect, enrich, and store data. We'll use the Snowplow Javascript tracker on our website, which generates event-data and send it to the Snowplow Collector to load to S3.</p>\n<p>Before loading the data, we'll use Enricher to turn IP addresses into coordinates. We'll use AWS Kinesis to manage data streams for collection, enrichment, and then finally loading into S3. The schema below illustrates the whole process.</p>\n<p><img src=\"/images/2-schema-1.png\"></p>\n<p>Let's start by setting up the tracker. Adding Snowplow's tracker to the website is the same, as adding Google Analytics or Mixpanel tracker. You need to add the asynchronous Javascript code, which loads the tracker itself.</p>\n<div class=\"gatsby-highlight\" data-language=\"javascript\"><pre class=\"language-javascript\"><code class=\"language-javascript\"><span class=\"token operator\">&lt;</span><span class=\"token operator\">!</span><span class=\"token operator\">--</span> Snowplow starts plowing <span class=\"token operator\">--</span><span class=\"token operator\">></span>\n<span class=\"token operator\">&lt;</span>script type<span class=\"token operator\">=</span><span class=\"token string\">\"text/javascript\"</span><span class=\"token operator\">></span>\n<span class=\"token punctuation\">;</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">function</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">p<span class=\"token punctuation\">,</span>l<span class=\"token punctuation\">,</span>o<span class=\"token punctuation\">,</span>w<span class=\"token punctuation\">,</span>i<span class=\"token punctuation\">,</span>n<span class=\"token punctuation\">,</span>g</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">{</span><span class=\"token keyword\">if</span><span class=\"token punctuation\">(</span><span class=\"token operator\">!</span>p<span class=\"token punctuation\">[</span>i<span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">{</span>p<span class=\"token punctuation\">.</span>GlobalSnowplowNamespace<span class=\"token operator\">=</span>p<span class=\"token punctuation\">.</span>GlobalSnowplowNamespace<span class=\"token operator\">||</span><span class=\"token punctuation\">[</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">;</span>\np<span class=\"token punctuation\">.</span>GlobalSnowplowNamespace<span class=\"token punctuation\">.</span><span class=\"token function\">push</span><span class=\"token punctuation\">(</span>i<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>p<span class=\"token punctuation\">[</span>i<span class=\"token punctuation\">]</span><span class=\"token operator\">=</span><span class=\"token keyword\">function</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">{</span><span class=\"token punctuation\">(</span>p<span class=\"token punctuation\">[</span>i<span class=\"token punctuation\">]</span><span class=\"token punctuation\">.</span>q<span class=\"token operator\">=</span>p<span class=\"token punctuation\">[</span>i<span class=\"token punctuation\">]</span><span class=\"token punctuation\">.</span>q<span class=\"token operator\">||</span><span class=\"token punctuation\">[</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">push</span><span class=\"token punctuation\">(</span>arguments<span class=\"token punctuation\">)</span>\n<span class=\"token punctuation\">}</span><span class=\"token punctuation\">;</span>p<span class=\"token punctuation\">[</span>i<span class=\"token punctuation\">]</span><span class=\"token punctuation\">.</span>q<span class=\"token operator\">=</span>p<span class=\"token punctuation\">[</span>i<span class=\"token punctuation\">]</span><span class=\"token punctuation\">.</span>q<span class=\"token operator\">||</span><span class=\"token punctuation\">[</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">;</span>n<span class=\"token operator\">=</span>l<span class=\"token punctuation\">.</span><span class=\"token function\">createElement</span><span class=\"token punctuation\">(</span>o<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>g<span class=\"token operator\">=</span>l<span class=\"token punctuation\">.</span><span class=\"token function\">getElementsByTagName</span><span class=\"token punctuation\">(</span>o<span class=\"token punctuation\">)</span><span class=\"token punctuation\">[</span><span class=\"token number\">0</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">;</span>n<span class=\"token punctuation\">.</span>async<span class=\"token operator\">=</span><span class=\"token number\">1</span><span class=\"token punctuation\">;</span>\nn<span class=\"token punctuation\">.</span>src<span class=\"token operator\">=</span>w<span class=\"token punctuation\">;</span>g<span class=\"token punctuation\">.</span>parentNode<span class=\"token punctuation\">.</span><span class=\"token function\">insertBefore</span><span class=\"token punctuation\">(</span>n<span class=\"token punctuation\">,</span>g<span class=\"token punctuation\">)</span><span class=\"token punctuation\">}</span><span class=\"token punctuation\">}</span><span class=\"token punctuation\">(</span>window<span class=\"token punctuation\">,</span>document<span class=\"token punctuation\">,</span><span class=\"token string\">\"script\"</span><span class=\"token punctuation\">,</span><span class=\"token string\">\"//d1fc8wv8zag5ca.cloudfront.net/2.10.2/sp.js\"</span><span class=\"token punctuation\">,</span><span class=\"token string\">\"snowplow\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\nwindow<span class=\"token punctuation\">.</span><span class=\"token function\">snowplow</span><span class=\"token punctuation\">(</span><span class=\"token string\">'newTracker'</span><span class=\"token punctuation\">,</span> <span class=\"token string\">'cf'</span><span class=\"token punctuation\">,</span> <span class=\"token string\">'{{MY-COLLECTOR-URI}}'</span><span class=\"token punctuation\">,</span> <span class=\"token punctuation\">{</span> <span class=\"token comment\">// Initialise a tracker</span>\n  appId<span class=\"token operator\">:</span> <span class=\"token string\">'{{MY-SITE-ID}}'</span><span class=\"token punctuation\">,</span>\n  cookieDomain<span class=\"token operator\">:</span> <span class=\"token string\">'{{MY-COOKIE-DOMAIN}}'</span>\n<span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\nwindow<span class=\"token punctuation\">.</span><span class=\"token function\">snowplow</span><span class=\"token punctuation\">(</span><span class=\"token string\">'trackPageView'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token operator\">&lt;</span><span class=\"token operator\">/</span>script<span class=\"token operator\">></span>\n<span class=\"token operator\">&lt;</span><span class=\"token operator\">!</span><span class=\"token operator\">--</span> Snowplow stops plowing <span class=\"token operator\">--</span><span class=\"token operator\">></span></code></pre></div>\n<p>The above snippet references a Snowplow Analytics hosted version of the Snowplow JavaScript tracker v2.10.2 (//d1fc8wv8zag5ca.cloudfront.net/2.10.2/sp.js). Snowplow Analytics no longer hosts the latest versions of the Snowplow JavaScript tracker. It is recommended to self-host <code class=\"language-text\">sp.js</code> by following the <a href=\"https://github.com/snowplow/snowplow/wiki/self-hosting-snowplow-js\">Self-hosting Snowplow.js</a> guide.</p>\n<p>For more details about setting up the tracker, please refer to the <a href=\"https://github.com/snowplow/snowplow/wiki/Setting-up-a-Tracker\">official Snowplow Javascript Tracker Setup guide</a>.</p>\n<p>To collect the data from the tracker, we need to setup Snowplow Collector. We'll use Scala Stream Collector. To collect the data from the tracker, we need to setup Snowplow Collector. We'll use Scala Stream Collector. <a href=\"https://github.com/snowplow/snowplow/wiki/Setting-up-the-Scala-Stream-Collector\">Here the detailed guide</a> on how to install and configure it. <a href=\"https://github.com/snowplow/snowplow-docker\">This repository with the Docker images</a> for the Snowplow components is very helpful if you plan to deploy Snowplow with Docker.</p>\n<p>Next, we need to install Snowplow Stream Enrich. Same as for collector, I\nrecommend following the official guide here and use these Docker images.</p>\n<p>Finally, we need to have S3 Loader installed and configured to consume records\nfrom AWS Kinesis and writes them to S3. You can follow <a href=\"https://github.com/snowplow/snowplow/wiki/snowplow-s3-loader-setup\">this guide</a> to set it up it.</p>\n<h2 id=\"query-s3-with-athena\" style=\"position:relative;\"><a href=\"#query-s3-with-athena\" aria-label=\"query s3 with athena permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Query S3 with Athena</h2>\n<p>Once we have data in S3 we can query it with AWS Athena or Presto. We’ll use Athena in our guide, but you can easily find a lot of materials online on how to set up an alternative configuration.</p>\n<p>To query S3 data with Athena, we need to create a table for Snowplow events. Copy and paste the following DDL statement into the Athena console. Modify the LOCATION for the S3 bucket that stores your enriched Snowplow events.</p>\n<div class=\"gatsby-highlight\" data-language=\"sql\"><pre class=\"language-sql\"><code class=\"language-sql\"><span class=\"token keyword\">CREATE</span> EXTERNAL <span class=\"token keyword\">TABLE</span> snowplow_events <span class=\"token punctuation\">(</span>\n  app_id STRING<span class=\"token punctuation\">,</span>\n  platform STRING<span class=\"token punctuation\">,</span>\n  etl_tstamp <span class=\"token keyword\">TIMESTAMP</span><span class=\"token punctuation\">,</span>\n  collector_tstamp <span class=\"token keyword\">TIMESTAMP</span><span class=\"token punctuation\">,</span>\n  dvce_tstamp <span class=\"token keyword\">TIMESTAMP</span><span class=\"token punctuation\">,</span>\n  event STRING<span class=\"token punctuation\">,</span>\n  event_id STRING<span class=\"token punctuation\">,</span>\n  txn_id <span class=\"token keyword\">INT</span><span class=\"token punctuation\">,</span>\n  name_tracker STRING<span class=\"token punctuation\">,</span>\n  v_tracker STRING<span class=\"token punctuation\">,</span>\n  v_collector STRING<span class=\"token punctuation\">,</span>\n  v_etl STRING<span class=\"token punctuation\">,</span>\n  user_id STRING<span class=\"token punctuation\">,</span>\n  user_ipaddress STRING<span class=\"token punctuation\">,</span>\n  user_fingerprint STRING<span class=\"token punctuation\">,</span>\n  domain_userid STRING<span class=\"token punctuation\">,</span>\n  domain_sessionidx <span class=\"token keyword\">INT</span><span class=\"token punctuation\">,</span>\n  network_userid STRING<span class=\"token punctuation\">,</span>\n  geo_country STRING<span class=\"token punctuation\">,</span>\n  geo_region STRING<span class=\"token punctuation\">,</span>\n  geo_city STRING<span class=\"token punctuation\">,</span>\n  geo_zipcode STRING<span class=\"token punctuation\">,</span>\n  geo_latitude STRING<span class=\"token punctuation\">,</span>\n  geo_longitude STRING<span class=\"token punctuation\">,</span>\n  geo_region_name STRING<span class=\"token punctuation\">,</span>\n  ip_isp STRING<span class=\"token punctuation\">,</span>\n  ip_organization STRING<span class=\"token punctuation\">,</span>\n  ip_domain STRING<span class=\"token punctuation\">,</span>\n  ip_netspeed STRING<span class=\"token punctuation\">,</span>\n  page_url STRING<span class=\"token punctuation\">,</span>\n  page_title STRING<span class=\"token punctuation\">,</span>\n  page_referrer STRING<span class=\"token punctuation\">,</span>\n  page_urlscheme STRING<span class=\"token punctuation\">,</span>\n  page_urlhost STRING<span class=\"token punctuation\">,</span>\n  page_urlport <span class=\"token keyword\">INT</span><span class=\"token punctuation\">,</span>\n  page_urlpath STRING<span class=\"token punctuation\">,</span>\n  page_urlquery STRING<span class=\"token punctuation\">,</span>\n  page_urlfragment STRING<span class=\"token punctuation\">,</span>\n  refr_urlscheme STRING<span class=\"token punctuation\">,</span>\n  refr_urlhost STRING<span class=\"token punctuation\">,</span>\n  refr_urlport <span class=\"token keyword\">INT</span><span class=\"token punctuation\">,</span>\n  refr_urlpath STRING<span class=\"token punctuation\">,</span>\n  refr_urlquery STRING<span class=\"token punctuation\">,</span>\n  refr_urlfragment STRING<span class=\"token punctuation\">,</span>\n  refr_medium STRING<span class=\"token punctuation\">,</span>\n  refr_source STRING<span class=\"token punctuation\">,</span>\n  refr_term STRING<span class=\"token punctuation\">,</span>\n  mkt_medium STRING<span class=\"token punctuation\">,</span>\n  mkt_source STRING<span class=\"token punctuation\">,</span>\n  mkt_term STRING<span class=\"token punctuation\">,</span>\n  mkt_content STRING<span class=\"token punctuation\">,</span>\n  mkt_campaign STRING<span class=\"token punctuation\">,</span>\n  contexts STRING<span class=\"token punctuation\">,</span>\n  se_category STRING<span class=\"token punctuation\">,</span>\n  se_action STRING<span class=\"token punctuation\">,</span>\n  se_label STRING<span class=\"token punctuation\">,</span>\n  se_property STRING<span class=\"token punctuation\">,</span>\n  se_value STRING<span class=\"token punctuation\">,</span>\n  unstruct_event STRING<span class=\"token punctuation\">,</span>\n  tr_orderid STRING<span class=\"token punctuation\">,</span>\n  tr_affiliation STRING<span class=\"token punctuation\">,</span>\n  tr_total STRING<span class=\"token punctuation\">,</span>\n  tr_tax STRING<span class=\"token punctuation\">,</span>\n  tr_shipping STRING<span class=\"token punctuation\">,</span>\n  tr_city STRING<span class=\"token punctuation\">,</span>\n  tr_state STRING<span class=\"token punctuation\">,</span>\n  tr_country STRING<span class=\"token punctuation\">,</span>\n  ti_orderid STRING<span class=\"token punctuation\">,</span>\n  ti_sku STRING<span class=\"token punctuation\">,</span>\n  ti_name STRING<span class=\"token punctuation\">,</span>\n  ti_category STRING<span class=\"token punctuation\">,</span>\n  ti_price STRING<span class=\"token punctuation\">,</span>\n  ti_quantity <span class=\"token keyword\">INT</span><span class=\"token punctuation\">,</span>\n  pp_xoffset_min <span class=\"token keyword\">INT</span><span class=\"token punctuation\">,</span>\n  pp_xoffset_max <span class=\"token keyword\">INT</span><span class=\"token punctuation\">,</span>\n  pp_yoffset_min <span class=\"token keyword\">INT</span><span class=\"token punctuation\">,</span>\n  pp_yoffset_max <span class=\"token keyword\">INT</span><span class=\"token punctuation\">,</span>\n  useragent STRING<span class=\"token punctuation\">,</span>\n  br_name STRING<span class=\"token punctuation\">,</span>\n  br_family STRING<span class=\"token punctuation\">,</span>\n  br_version STRING<span class=\"token punctuation\">,</span>\n  br_type STRING<span class=\"token punctuation\">,</span>\n  br_renderengine STRING<span class=\"token punctuation\">,</span>\n  br_lang STRING<span class=\"token punctuation\">,</span>\n  br_features_pdf STRING<span class=\"token punctuation\">,</span>\n  br_features_flash STRING<span class=\"token punctuation\">,</span>\n  br_features_java STRING<span class=\"token punctuation\">,</span>\n  br_features_director STRING<span class=\"token punctuation\">,</span>\n  br_features_quicktime STRING<span class=\"token punctuation\">,</span>\n  br_features_realplayer STRING<span class=\"token punctuation\">,</span>\n  br_features_windowsmedia STRING<span class=\"token punctuation\">,</span>\n  br_features_gears STRING<span class=\"token punctuation\">,</span>\n  br_features_silverlight STRING<span class=\"token punctuation\">,</span>\n  br_cookies STRING<span class=\"token punctuation\">,</span>\n  br_colordepth STRING<span class=\"token punctuation\">,</span>\n  br_viewwidth <span class=\"token keyword\">INT</span><span class=\"token punctuation\">,</span>\n  br_viewheight <span class=\"token keyword\">INT</span><span class=\"token punctuation\">,</span>\n  os_name STRING<span class=\"token punctuation\">,</span>\n  os_family STRING<span class=\"token punctuation\">,</span>\n  os_manufacturer STRING<span class=\"token punctuation\">,</span>\n  os_timezone STRING<span class=\"token punctuation\">,</span>\n  dvce_type STRING<span class=\"token punctuation\">,</span>\n  dvce_ismobile STRING<span class=\"token punctuation\">,</span>\n  dvce_screenwidth <span class=\"token keyword\">INT</span><span class=\"token punctuation\">,</span>\n  dvce_screenheight <span class=\"token keyword\">INT</span><span class=\"token punctuation\">,</span>\n  doc_charset STRING<span class=\"token punctuation\">,</span>\n  doc_width <span class=\"token keyword\">INT</span><span class=\"token punctuation\">,</span>\n  doc_height <span class=\"token keyword\">INT</span><span class=\"token punctuation\">,</span>\n  tr_currency STRING<span class=\"token punctuation\">,</span>\n  tr_total_base STRING<span class=\"token punctuation\">,</span>\n  tr_tax_base STRING<span class=\"token punctuation\">,</span>\n  tr_shipping_base STRING<span class=\"token punctuation\">,</span>\n  ti_currency STRING<span class=\"token punctuation\">,</span>\n  ti_price_base STRING<span class=\"token punctuation\">,</span>\n  base_currency STRING<span class=\"token punctuation\">,</span>\n  geo_timezone STRING<span class=\"token punctuation\">,</span>\n  mkt_clickid STRING<span class=\"token punctuation\">,</span>\n  mkt_network STRING<span class=\"token punctuation\">,</span>\n  etl_tags STRING<span class=\"token punctuation\">,</span>\n  dvce_sent_tstamp <span class=\"token keyword\">TIMESTAMP</span><span class=\"token punctuation\">,</span>\n  refr_domain_userid STRING<span class=\"token punctuation\">,</span>\n  refr_dvce_tstamp <span class=\"token keyword\">TIMESTAMP</span><span class=\"token punctuation\">,</span>\n  derived_contexts STRING<span class=\"token punctuation\">,</span>\n  domain_sessionid STRING<span class=\"token punctuation\">,</span>\n  derived_tstamp <span class=\"token keyword\">TIMESTAMP</span>\n<span class=\"token punctuation\">)</span>\nPARTITIONED <span class=\"token keyword\">BY</span><span class=\"token punctuation\">(</span>run STRING<span class=\"token punctuation\">)</span>\n<span class=\"token keyword\">ROW</span> FORMAT DELIMITED\n<span class=\"token keyword\">FIELDS</span> <span class=\"token keyword\">TERMINATED</span> <span class=\"token keyword\">BY</span> <span class=\"token string\">'\\\\t'</span>\nSTORED <span class=\"token keyword\">AS</span> TEXTFILE\nLOCATION <span class=\"token string\">'s3://bucket-name/path/to/enriched/good'</span><span class=\"token punctuation\">;</span></code></pre></div>\n<p>Now, we're ready to connect Cube.js to Athena and start building our\napplication.</p>","timeToRead":4,"excerpt":"We're going to use Snowplow for data collection, S3 for storage, and Athena to query the data in S3. Data Collection with Snowplow Snowplow…","frontmatter":{"title":"Data Collection and Storage"},"fields":{"slug":"/data-collection-and-storage"}}},"pageContext":{"config":{"siteTitle":"Building an Open Source Web Analytics Platform","siteTitleShort":"Building an Open Source Web Analytics Platform","siteTitleAlt":"Building an Open Source Web Analytics Platform","siteLogo":"/logos/icon.png","previewImage":"/logos/preview.png","siteUrl":"https://web-analytics.cube.dev","siteDescription":"Learn how to build open source web analytics platform with Cube.js.","googleAnalyticsID":"UA-70480064-3","themeColor":"#c62828","backgroundColor":"#e0e0e0","pathPrefix":"","githubUrl":"https://github.com/cube-js/cube.js/tree/master/examples/web-analytics"},"slug":"/data-collection-and-storage","nexttitle":"Analytics API with Cube.js","nextslug":"/analytics-api-with-cube-js","prevtitle":"Overview","prevslug":"/overview","tableOfContents":[{"node":{"fields":{"slug":"/overview"},"frontmatter":{"title":"Overview","order":1}}},{"node":{"fields":{"slug":"/data-collection-and-storage"},"frontmatter":{"title":"Data Collection and Storage","order":2}}},{"node":{"fields":{"slug":"/analytics-api-with-cube-js"},"frontmatter":{"title":"Analytics API with Cube.js","order":3}}},{"node":{"fields":{"slug":"/frontend-app-with-react-and-material-ui"},"frontmatter":{"title":"Frontend App with React and Material UI","order":4}}},{"node":{"fields":{"slug":"/building-a-dashboard"},"frontmatter":{"title":"Building a Dashboard","order":5}}},{"node":{"fields":{"slug":"/adding-interactivity"},"frontmatter":{"title":"Adding Interactivity","order":6}}},{"node":{"fields":{"slug":"/performance-and-cost-optimization"},"frontmatter":{"title":"Performance and Cost Optimization","order":7}}}]}},"staticQueryHashes":[]}